{
    "contents" : "DATADIR <- '~/drive/research/ibs/data/'\nmapfp <- paste(DATADIR,'mappingfile_deidentified_nov2015_edit.txt',sep='')\ntaxfp <- paste(DATADIR,'taxonomy_table.txt',sep='')\n\nm <- read.table(mapfp, sep='\\t',head=T,row=1,check=F,comment='')\nx <- t(read.table(taxfp, sep='\\t',head=T,row=1,check=F,comment=''))\nx <- x[rownames(m),]\nx <- x[,colnames(x) != '_']\n\n# species only\nxsp <- x[,!grepl('_$',colnames(x))]\ncolnames(xsp) <- gsub('_',' ',colnames(xsp))\n\n# genus only\ngenus <- sapply(strsplit(colnames(x),'_'),'[',1)\nxgn <- t(apply(x,1, function(xx) sapply(split(xx,genus),sum)))\n\n# drop low-abundance samples\nxsp <- xsp[rowSums(xsp) > 1000,]\nxgn <- xgn[rownames(xsp),]\nm <- m[rownames(xsp),]\n\n# normalize \n# xsp <- sweep(xsp, 1, rowSums(xgn), '/') # normalize species by genus-level assignments\nxsp.raw <- xsp\nxgn.raw <- xgn\nxsp <- sweep(xsp, 1, rowSums(xsp), '/')\nxgn <- sweep(xgn, 1, rowSums(xgn), '/')\n\n# collapse by subject using mean\nxspc <- apply(xsp,2,function(xx) sapply(split(xx,m$Patient_no.),mean))\nrownames(xspc) <- sprintf('Subject_%03d',sapply(split(m$Patient_no.,m$Patient_no.),'[',1))\nxgnc <- apply(xgn,2,function(xx) sapply(split(xx,m$Patient_no.),mean))\nrownames(xgnc) <- sprintf('Subject_%03d',sapply(split(m$Patient_no.,m$Patient_no.),'[',1))\nmc <- m[sapply(split(1:nrow(m),m$Patient_no.),'[',1),,drop=TRUE]\nrownames(mc) <- sprintf('Subject_%03d',sapply(split(m$Patient_no.,m$Patient_no.),'[',1))\n\n# collapse by subject using first sample, for example\nxspc.first <- apply(xsp,2,function(xx) sapply(split(xx,m$Patient_no.),'[',1))\nrownames(xspc.first) <- sprintf('Subject_%03d',sapply(split(m$Patient_no.,m$Patient_no.),'[',1))\nxgnc.first <- apply(xgn,2,function(xx) sapply(split(xx,m$Patient_no.),'[',1))\nrownames(xgnc.first) <- sprintf('Subject_%03d',sapply(split(m$Patient_no.,m$Patient_no.),'[',1))\nmc <- m[sapply(split(1:nrow(m),m$Patient_no.),'[',1),,drop=TRUE]\nrownames(mc) <- sprintf('Subject_%03d',sapply(split(m$Patient_no.,m$Patient_no.),'[',1))\n\n\nxspc.raw <- apply(xsp.raw,2,function(xx) sapply(split(xx,m$Patient_no.),sum))\nrownames(xspc.raw) <- sprintf('Subject_%03d',sapply(split(m$Patient_no.,m$Patient_no.),'[',1))\nxgnc.raw <- apply(xgn.raw,2,function(xx) sapply(split(xx,m$Patient_no.),sum))\nrownames(xgnc.raw) <- sprintf('Subject_%03d',sapply(split(m$Patient_no.,m$Patient_no.),'[',1))\n\n# this was included only as an experiment to see if results could be retained using just one sample\n# xspc <- xspc.first\n# xgnc <- xgnc.first\n\n# drop rare bugs (show up in less than 25% of subjects)\nrare.sp.ix <- colMeans(xspc > 0) < .25\nrare.gn.ix <- colMeans(xgnc > 0) < .25\nxsp <- xsp[,!rare.sp.ix]\nxgn <- xgn[,!rare.gn.ix]\nxspc <- xspc[,!rare.sp.ix]\nxgnc <- xgnc[,!rare.gn.ix]\nxspc.first <- xspc.first[,!rare.sp.ix]\nxgnc.first <- xgnc.first[,!rare.gn.ix]\n\nxsp.raw <- xsp.raw[,!rare.sp.ix]\nxgn.raw <- xgn.raw[,!rare.gn.ix]\nxspc.raw <- xspc.raw[,!rare.sp.ix]\nxgnc.raw <- xgnc.raw[,!rare.gn.ix]\n\n# gather differentiation indicies\nixc.hc <- mc$Cohort == \"Healthy\"\nix.hc <- m$Cohort == \"Healthy\"\nixc.ibsc <- mc$Cohort == \"IBS-C\"\nix.ibsc <- m$Cohort == \"IBS-C\"\nixc.ibsd <- mc$Cohort == \"IBS-D\"\nix.ibsd <- m$Cohort == \"IBS-D\"\nixc.ibs <- mc$Cohort != \"Healthy\"\nix.ibs <- m$Cohort != \"Healthy\"\n\n# difftest <- differentiation.test(xc, mc$Cohort)\n\nsink('map.txt'); cat('#SampleID\\t'); write.table(m, sep='\\t',quote=F); sink(NULL)\nsink('species.txt'); cat('Taxon\\t'); write.table(t(xsp), sep='\\t',quote=F); sink(NULL)\nsink('genus.txt'); cat('Taxon\\t'); write.table(t(xgn), sep='\\t',quote=F); sink(NULL)\nsink('map-collapsed.txt'); cat('#SampleID\\t'); write.table(mc, sep='\\t',quote=F); sink(NULL)\nsink('species-collapsed.txt'); cat('Taxon\\t'); write.table(t(xspc), sep='\\t',quote=F); sink(NULL)\nsink('genus-collapsed.txt'); cat('Taxon\\t'); write.table(t(xgnc), sep='\\t',quote=F); sink(NULL)\nsink('map-collapsed-first-sample-per-subject.txt'); cat('#SampleID\\t'); write.table(mc, sep='\\t',quote=F); sink(NULL)\nsink('species-collapsed-first-sample-per-subject.txt'); cat('Taxon\\t'); write.table(t(xspc.first), sep='\\t',quote=F); sink(NULL)\nsink('genus-collapsed-first-sample-per-subject.txt'); cat('Taxon\\t'); write.table(t(xgnc.first), sep='\\t',quote=F); sink(NULL)\n\n",
    "created" : 1463061506897.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3188447587",
    "id" : "6BD63621",
    "lastKnownWriteTime" : 1460400714,
    "path" : "B:/Projects/NINJA-SHOGUN/src/bin/load.r",
    "project_path" : "src/bin/load.r",
    "properties" : {
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "type" : "r_source"
}